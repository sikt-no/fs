include:
  - component: $CI_SERVER_FQDN/platon/ci-components/docker/docker@2
  - component: $CI_SERVER_FQDN/platon/ci-components/deploy/deploy@1

variables:
  KUBE_PROD_DOMAIN: fs-funksjonelltesting.sokrates.edupaas.no
  KUBE_TEST_ID: fs-funksjonelltesting
  HTTP_PORT: '80'
  REPLICAS: '1'

  # User-configurable variables (set when triggering pipeline)
  TEST_ENV: "functionaltest"  # Options: "test" or "functionaltest"
  BDD_TAGS: "@smoke"

  # Credentials (same for both environments)
  FS_ADMIN_USERNAME: kari456staff
  FS_ADMIN_PASSWORD: 098asd
  FS_ADMIN_OVERSTYRT_BRUKER: "11906698511:970 422 528"
  PERSONSOK_ADMIN_OVERSTYRT_BRUKER: "07577790366:919477822"

stages:
  - test
  - build
  - production

e2e_tests:
  stage: test
  allow_failure:
    exit_codes: [2]
  tags:
    - fs-plattform
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  before_script:
    - cd tester
    - apt-get update && apt-get install -y default-jre curl unzip gettext-base jq
    - npm ci
    # Generate report timestamp (used for Slack links and report organization)
    - export REPORT_TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
    - echo "$REPORT_TIMESTAMP" > report-timestamp.txt
    # Setup test environment URLs based on TEST_ENV (critical - must succeed)
    - source ../scripts/setup-test-env.sh
    # Fetch Allure history from previous successful pipeline (nice-to-have - fail gracefully)
    - ../scripts/fetch-allure-history.sh || true
  script:
    - source /tmp/test-env.sh
    - BDD_TAGS="$BDD_TAGS" npx bddgen || (curl -sS -X POST -H "Content-type:application/json" -d '{"text":"bddgen failed: Gherkin parse error in '${CI_PROJECT_NAME}' pipeline '${CI_PIPELINE_URL}'"}' "$SLACK_WEBHOOK" && exit 1)
    - npx playwright test || TEST_FAILED=1
    - npx allure awesome allure-results -o allure-report
    - if [ "$TEST_FAILED" = "1" ]; then exit 2; fi
  after_script:
    - cd tester
    # Extract test metrics and generate Slack payload (nice-to-have - fail gracefully)
    - ../scripts/generate-slack-payload.sh || true
  timeout: 30m
  artifacts:
    paths:
      - tester/playwright-report/
      - tester/allure-report/
      - tester/report-timestamp.txt
      - tester/slack-payload.json
    reports:
      junit: tester/test-results/junit.xml
    when: always
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "trigger"

prepare-reports:
  stage: build
  image: alpine:latest
  needs:
    - job: e2e_tests
      artifacts: true
  script:
    - export REPORT_TIMESTAMP=$(cat tester/report-timestamp.txt)
    - ./scripts/organize-reports.sh reports tester/playwright-report tester/allure-report "$REPORT_TIMESTAMP" "$TEST_ENV"
    - cp tester/slack-payload.json reports/
  artifacts:
    paths:
      - reports/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "trigger"

build:
  extends: .platon-docker-build
  stage: build
  needs:
    - job: prepare-reports
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "trigger"

production:
  extends: .production
  stage: production
  needs:
    - job: build
    - job: prepare-reports
      artifacts: true
  script:
    - deploy deployment.yaml
  after_script:
    - 'curl -sS -w "\nHTTP Status: %{http_code}\n" -X POST -H "Content-type: application/json" -d @reports/slack-payload.json "$SLACK_WEBHOOK"'
  when: on_success
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "trigger"

stop_production:
  extends: .stop_production
  stage: production
