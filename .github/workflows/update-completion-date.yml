name: Automatisk Ferdigdato og Status

on:
  issues:
    types: [closed]

permissions:
  issues: write
  pull-requests: write
  repository-projects: write
  contents: read

jobs:
  update-completion-date:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sjekk om issue skal f√• ferdigdato
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Issue #${issueNumber} lukket`);
            console.log(`State reason: ${issue.state_reason}`);
            
            // Sjekk om issue er lukket som "not planned" - da skal vi IKKE sette ferdigdato
            if (issue.state_reason === 'not_planned') {
              console.log('Issue lukket som "not planned" - avbryter ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // Sjekk om issue har label som indikerer at den ikke skal ha ferdigdato
            const labels = issue.labels.map(label => label.name.toLowerCase());
            const skipLabels = ['wontfix', 'invalid', 'duplicate', 'ikke-planlagt', 'avvist'];
            const shouldSkip = labels.some(label => skipLabels.includes(label));
            
            if (shouldSkip) {
              console.log('Issue har label som indikerer at den ikke skal ha ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // For alle andre tilfeller (completed eller null), sett ferdigdato
            console.log('Issue skal f√• ferdigdato');
            core.setOutput('should_continue', 'true');

      - name: Sett ferdigdato og oppdater status til Levert
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Setter ferdigdato for issue #${issueNumber}`);
            
            // Sjekk om ferdigdato allerede er satt
            const body = issue.body || '';
            const completionDatePattern = /Ferdig\s*dato:\s*(\d{4}-\d{2}-\d{2})/i;
            const existingCompletionDate = body.match(completionDatePattern);
            
            if (!existingCompletionDate) {
              // Legg til ferdigdato i issue body
              let newBody = body;
              
              // Hvis body er tom, opprett grunnleggende struktur
              if (!body.trim()) {
                newBody = `## Beskrivelse\n\n## Ferdigdato\n${today}\n\n## Akseptansekriterier\n- [x] Ferdigstilt`;
              } else {
                // Legg til ferdigdato etter startdato eller p√• slutten
                if (newBody.includes('## Startdato') || newBody.includes('## Start dato')) {
                  // Finn startdato seksjon og legg til ferdigdato etter den
                  const lines = newBody.split('\n');
                  let insertIndex = -1;
                  
                  for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes('startdato') || lines[i].toLowerCase().includes('start dato')) {
                      insertIndex = i + 1;
                      // Finn slutten av startdato seksjonen
                      while (insertIndex < lines.length && 
                             !lines[insertIndex].startsWith('## ') && 
                             !lines[insertIndex].startsWith('# ') &&
                             lines[insertIndex].trim() !== '') {
                        insertIndex++;
                      }
                      break;
                    }
                  }
                  
                  if (insertIndex > -1) {
                    lines.splice(insertIndex, 0, '', '## Ferdigdato', today, '');
                  } else {
                    lines.push('', '## Ferdigdato', today, '');
                  }
                  newBody = lines.join('\n');
                } else if (newBody.includes('## ') || newBody.includes('# ')) {
                  // Legg til ferdigdato p√• slutten av strukturert innhold
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                } else {
                  // Legg til p√• slutten
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                }
              }
              
              // Oppdater issue med ny body
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: newBody
              });
              
              console.log(`Ferdigdato ${today} lagt til i issue #${issueNumber}`);
            } else {
              console.log('Ferdigdato allerede satt til:', existingCompletionDate[1]);
            }
            
            // Legg til "levert" label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['levert']
              });
              console.log(`'levert' label lagt til p√• issue #${issueNumber}`);
            } catch (error) {
              console.log('Kunne ikke legge til levert label:', error.message);
            }

      - name: Oppdater prosjekt-felter via GraphQL
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            console.log(`=== STARTER PROSJEKT-OPPDATERING FOR ISSUE #${issueNumber} ===`);
            console.log(`Dato som skal settes: ${today}`);
            
            try {
              // Query for √• finne issue og dens prosjekt-tilknytninger
              // Inkluderer b√•de repository og organization projects
              const findProjectsQuery = `
                query($owner: String!, $repo: String!, $issue: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issue) {
                      id
                      projectsV2(first: 20) {
                        nodes {
                          id
                          title
                          owner {
                            ... on Organization {
                              login
                            }
                            ... on Repository {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                  organization(login: $owner) {
                    projectsV2(first: 20) {
                      nodes {
                        id
                        title
                        items(first: 100) {
                          nodes {
                            id
                            content {
                              ... on Issue {
                                number
                                repository {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue: issueNumber
              };
              
              console.log('S√∏ker etter prosjekter...');
              const projectsResult = await github.graphql(findProjectsQuery, variables);
              
              const projectItems = [];
              
              // Sjekk repository-linked projects
              if (projectsResult.repository?.issue?.projectsV2?.nodes) {
                console.log(`Fant ${projectsResult.repository.issue.projectsV2.nodes.length} repository-prosjekter`);
                for (const project of projectsResult.repository.issue.projectsV2.nodes) {
                  console.log(`- ${project.title} (ID: ${project.id})`);
                }
              }
              
              // Sjekk organization projects
              if (projectsResult.organization?.projectsV2?.nodes) {
                console.log(`\nS√∏ker gjennom ${projectsResult.organization.projectsV2.nodes.length} organization-prosjekter...`);
                
                for (const project of projectsResult.organization.projectsV2.nodes) {
                  // Finn items som matcher v√•r issue
                  const matchingItem = project.items.nodes.find(item => 
                    item.content?.number === issueNumber && 
                    item.content?.repository?.name === context.repo.repo
                  );
                  
                  if (matchingItem) {
                    console.log(`‚úì Fant issue i organization-prosjekt: ${project.title}`);
                    projectItems.push({
                      itemId: matchingItem.id,
                      projectId: project.id,
                      projectTitle: project.title
                    });
                  }
                }
              }
              
              console.log(`\n=== FANT TOTALT ${projectItems.length} PROSJEKT-TILKNYTNINGER ===`);
              
              if (projectItems.length === 0) {
                console.log('‚ö†Ô∏è Ingen prosjekt-tilknytninger funnet for denne issuen');
                
                // Pr√∏v alternativ metode for √• finne project items
                const alternativeQuery = `
                  query($nodeId: ID!) {
                    node(id: $nodeId) {
                      ... on Issue {
                        projectItems(first: 20) {
                          nodes {
                            id
                            project {
                              id
                              title
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const issueNodeId = context.payload.issue.node_id;
                console.log(`Pr√∏ver alternativ metode med node_id: ${issueNodeId}`);
                
                const altResult = await github.graphql(alternativeQuery, { nodeId: issueNodeId });
                
                if (altResult.node?.projectItems?.nodes) {
                  for (const item of altResult.node.projectItems.nodes) {
                    console.log(`‚úì Fant via alternativ metode: ${item.project.title}`);
                    projectItems.push({
                      itemId: item.id,
                      projectId: item.project.id,
                      projectTitle: item.project.title
                    });
                  }
                }
              }
              
              // Oppdater hvert prosjekt
              for (const projectItem of projectItems) {
                console.log(`\n=== BEHANDLER PROSJEKT: ${projectItem.projectTitle} ===`);
                
                try {
                  // Hent prosjektets felter
                  const fieldsQuery = `
                    query($projectId: ID!) {
                      node(id: $projectId) {
                        ... on ProjectV2 {
                          fields(first: 50) {
                            nodes {
                              ... on ProjectV2Field {
                                id
                                name
                                dataType
                              }
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                                dataType
                                options {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  `;
                  
                  const fieldsResult = await github.graphql(fieldsQuery, {
                    projectId: projectItem.projectId
                  });
                  
                  const fields = fieldsResult.node.fields.nodes;
                  console.log('Prosjektfelter:');
                  fields.forEach(f => {
                    console.log(`  - ${f.name} (${f.dataType})`);
                  });
                  
                  // Finn Status-felt
                  const statusField = fields.find(f => 
                    f.name.toLowerCase() === 'status' && 
                    f.dataType === 'SINGLE_SELECT'
                  );
                  
                  if (statusField && statusField.options) {
                    console.log('\nStatus-opsjoner funnet:');
                    statusField.options.forEach(opt => console.log(`  - ${opt.name}`));
                    
                    const levertOption = statusField.options.find(opt => 
                      opt.name.toLowerCase().includes('levert') ||
                      opt.name.toLowerCase().includes('ferdig') ||
                      opt.name.toLowerCase().includes('done') ||
                      opt.name.toLowerCase().includes('complete')
                    );
                    
                    if (levertOption) {
                      const statusMutation = `
                        mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                          updateProjectV2ItemFieldValue(input: $input) {
                            projectV2Item {
                              id
                            }
                          }
                        }
                      `;
                      
                      await github.graphql(statusMutation, {
                        input: {
                          projectId: projectItem.projectId,
                          itemId: projectItem.itemId,
                          fieldId: statusField.id,
                          value: { 
                            singleSelectOptionId: levertOption.id
                          }
                        }
                      });
                      
                      console.log(`‚úì Status oppdatert til: ${levertOption.name}`);
                    }
                  }
                  
                  // Finn Ferdigdato-felt - sjekk ALLE mulige navn
                  console.log('\nS√∏ker etter ferdigdato-felt...');
                  const dateFields = fields.filter(f => f.dataType === 'DATE');
                  console.log(`Dato-felter funnet: ${dateFields.map(f => f.name).join(', ')}`);
                  
                  const ferdigdatoField = fields.find(f => {
                    if (f.dataType !== 'DATE') return false;
                    
                    const fieldNameLower = f.name.toLowerCase();
                    const fieldNameNoSpace = fieldNameLower.replace(/\s+/g, '');
                    
                    // Sjekk mange varianter
                    return fieldNameLower === 'ferdigdato' ||
                           fieldNameLower === 'ferdig dato' ||
                           fieldNameLower === 'ferdig-dato' ||
                           fieldNameNoSpace === 'ferdigdato' ||
                           fieldNameLower === 'sluttdato' ||
                           fieldNameLower === 'slutt dato' ||
                           fieldNameLower === 'slutt' ||
                           fieldNameLower === 'end date' ||
                           fieldNameLower === 'end' ||
                           fieldNameLower === 'completion date' ||
                           fieldNameLower === 'completed' ||
                           fieldNameLower === 'completed date' ||
                           f.name === 'Ferdigdato' ||
                           f.name === 'Ferdig dato';
                  });
                  
                  if (ferdigdatoField) {
                    console.log(`‚úì Ferdigdato-felt funnet: "${ferdigdatoField.name}"`);
                    
                    const dateMutation = `
                      mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                        updateProjectV2ItemFieldValue(input: $input) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `;
                    
                    await github.graphql(dateMutation, {
                      input: {
                        projectId: projectItem.projectId,
                        itemId: projectItem.itemId,
                        fieldId: ferdigdatoField.id,
                        value: {
                          date: today
                        }
                      }
                    });
                    
                    console.log(`‚úì Ferdigdato satt til: ${today}`);
                  } else {
                    console.log('‚ö†Ô∏è Ingen ferdigdato-felt funnet i dette prosjektet');
                    console.log('Tips: Sjekk at prosjektet har et dato-felt med navn som "Ferdigdato" eller "Ferdig dato"');
                  }
                  
                } catch (projectError) {
                  console.error(`Feil for prosjekt ${projectItem.projectTitle}:`, projectError.message);
                }
              }
              
              console.log('\n=== PROSJEKT-OPPDATERING FULLF√òRT ===');
              
            } catch (error) {
              console.error('=== FEIL I PROSJEKT-OPPDATERING ===');
              console.error('Feilmelding:', error.message);
              if (error.errors) {
                console.error('GraphQL errors:', JSON.stringify(error.errors, null, 2));
              }
              console.error('Stack trace:', error.stack);
            }

      - name: Legg til ferdigstillingskommentar
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Sak ferdigstilt**

Denne saken har automatisk blitt oppdatert:
- üìÖ Ferdigdato satt til: ${today}
- üè∑Ô∏è Status oppdatert til: Levert
- üìä Prosjekt-felter oppdatert

_Automatisk generert av GitHub Actions workflow_`
            });
            
            console.log(`Ferdigstillingskommentar lagt til p√• issue #${issueNumber}`);