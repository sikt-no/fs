name: Automatisk Ferdigdato og Status

on:
  issues:
    types: [closed]

jobs:
  update-completion-date:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sjekk om issue skal f√• ferdigdato
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Issue #${issueNumber} lukket`);
            console.log(`State reason: ${issue.state_reason}`);
            
            // Sjekk om issue er lukket som "not planned" - da skal vi IKKE sette ferdigdato
            if (issue.state_reason === 'not_planned') {
              console.log('Issue lukket som "not planned" - avbryter ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // Sjekk om issue har label som indikerer at den ikke skal ha ferdigdato
            const labels = issue.labels.map(label => label.name.toLowerCase());
            const skipLabels = ['wontfix', 'invalid', 'duplicate', 'ikke-planlagt', 'avvist'];
            const shouldSkip = labels.some(label => skipLabels.includes(label));
            
            if (shouldSkip) {
              console.log('Issue har label som indikerer at den ikke skal ha ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // For alle andre tilfeller (completed eller null), sett ferdigdato
            console.log('Issue skal f√• ferdigdato');
            core.setOutput('should_continue', 'true');

      - name: Sett ferdigdato og oppdater status til Levert
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Setter ferdigdato for issue #${issueNumber}`);
            
            // Sjekk om ferdigdato allerede er satt
            const body = issue.body || '';
            const completionDatePattern = /Ferdig\s*dato:\s*(\d{4}-\d{2}-\d{2})/i;
            const existingCompletionDate = body.match(completionDatePattern);
            
            if (!existingCompletionDate) {
              // Legg til ferdigdato i issue body
              let newBody = body;
              
              // Hvis body er tom, opprett grunnleggende struktur
              if (!body.trim()) {
                newBody = `## Beskrivelse\n\n## Ferdigdato\n${today}\n\n## Akseptansekriterier\n- [x] Ferdigstilt`;
              } else {
                // Legg til ferdigdato etter startdato eller p√• slutten
                if (newBody.includes('## Startdato') || newBody.includes('## Start dato')) {
                  // Finn startdato seksjon og legg til ferdigdato etter den
                  const lines = newBody.split('\n');
                  let insertIndex = -1;
                  
                  for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes('startdato') || lines[i].toLowerCase().includes('start dato')) {
                      insertIndex = i + 1;
                      // Finn slutten av startdato seksjonen
                      while (insertIndex < lines.length && 
                             !lines[insertIndex].startsWith('## ') && 
                             !lines[insertIndex].startsWith('# ') &&
                             lines[insertIndex].trim() !== '') {
                        insertIndex++;
                      }
                      break;
                    }
                  }
                  
                  if (insertIndex > -1) {
                    lines.splice(insertIndex, 0, '', '## Ferdigdato', today, '');
                  } else {
                    lines.push('', '## Ferdigdato', today, '');
                  }
                  newBody = lines.join('\n');
                } else if (newBody.includes('## ') || newBody.includes('# ')) {
                  // Legg til ferdigdato p√• slutten av strukturert innhold
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                } else {
                  // Legg til p√• slutten
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                }
              }
              
              // Oppdater issue med ny body
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: newBody
              });
              
              console.log(`Ferdigdato ${today} lagt til i issue #${issueNumber}`);
            } else {
              console.log('Ferdigdato allerede satt til:', existingCompletionDate[1]);
            }
            
            // Legg til "levert" label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['levert']
              });
              console.log(`'levert' label lagt til p√• issue #${issueNumber}`);
            } catch (error) {
              console.log('Kunne ikke legge til levert label:', error.message);
            }

      - name: Flytt til Levert-kolonne i begge prosjekter
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Flytter issue #${issueNumber} til Levert-kolonne i prosjekter`);
            
            // Finn begge prosjekter - bruk GraphQL for Projects (beta)
            try {
              // F√∏rst pr√∏v classic projects API
              const { data: projects } = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              const offentligProject = projects.find(p => 
                p.name.toLowerCase().includes('offentlig') && 
                p.name.toLowerCase().includes('saksoversikt')
              );
              
              const internProject = projects.find(p => 
                p.name.toLowerCase().includes('saksoversikt') && 
                p.name.toLowerCase().includes('intern')
              );
              
              // Funksjon for √• flytte kort til Levert-kolonne
              const moveCardToLevert = async (project, projectName) => {
                if (!project) {
                  console.log(`${projectName} prosjekt ikke funnet i classic projects`);
                  return;
                }
                
                // Hent kolonner
                const { data: columns } = await github.rest.projects.listColumns({
                  project_id: project.id
                });
                
                // Finn Levert-kolonne
                const levertColumn = columns.find(col => 
                  col.name.toLowerCase().includes('levert') ||
                  col.name.toLowerCase().includes('ferdig') ||
                  col.name.toLowerCase().includes('done') ||
                  col.name.toLowerCase().includes('complete')
                );
                
                if (!levertColumn) {
                  console.log(`Kunne ikke finne Levert-kolonne i ${projectName}`);
                  console.log(`Tilgjengelige kolonner: ${columns.map(c => c.name).join(', ')}`);
                  return;
                }
                
                // Finn eksisterende kort for denne issue i alle kolonner
                let existingCard = null;
                for (const column of columns) {
                  const { data: columnCards } = await github.rest.projects.listCards({
                    column_id: column.id,
                    archived_state: 'all'
                  });
                  
                  existingCard = columnCards.find(card => 
                    card.content_url && card.content_url.includes(`/issues/${issueNumber}`)
                  );
                  
                  if (existingCard) {
                    console.log(`Fant kort i kolonne "${column.name}" i ${projectName}`);
                    break;
                  }
                }
                
                if (existingCard) {
                  // Flytt eksisterende kort til Levert-kolonne
                  await github.rest.projects.moveCard({
                    card_id: existingCard.id,
                    position: "top",
                    column_id: levertColumn.id
                  });
                  console.log(`Flyttet kort til "${levertColumn.name}" i ${projectName}`);
                } else {
                  // Opprett nytt kort i Levert-kolonne hvis det ikke finnes
                  await github.rest.projects.createCard({
                    column_id: levertColumn.id,
                    content_id: issue.id,
                    content_type: 'Issue'
                  });
                  console.log(`Opprettet nytt kort i "${levertColumn.name}" i ${projectName}`);
                }
              };
              
              // Flytt kort i begge prosjekter hvis de bruker classic projects
              if (offentligProject || internProject) {
                await moveCardToLevert(offentligProject, "FS Offentlig saksoversikt");
                await moveCardToLevert(internProject, "FS Saksoversikt (intern)");
              }
              
              // Pr√∏v ogs√• GraphQL for nye Projects (beta)
              const query = `
                query($owner: String!, $repo: String!, $issue: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issue) {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                            title
                            fields(first: 20) {
                              nodes {
                                ... on ProjectV2Field {
                                  id
                                  name
                                  dataType
                                }
                                ... on ProjectV2SingleSelectField {
                                  id
                                  name
                                  dataType
                                  options {
                                    id
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue: issueNumber
              };
              
              const result = await github.graphql(query, variables);
              
              if (result.repository.issue.projectItems.nodes.length > 0) {
                console.log('Fant issue i nye Projects (beta)');
                const today = new Date().toISOString().split('T')[0];
                
                for (const projectItem of result.repository.issue.projectItems.nodes) {
                  const project = projectItem.project;
                  const fields = project.fields.nodes;
                  
                  console.log(`Behandler prosjekt: ${project.title}`);
                  console.log(`Tilgjengelige felter: ${fields.map(f => `${f.name} (${f.dataType})`).join(', ')}`);
                  
                  // Finn Status-feltet
                  const statusField = fields.find(f => 
                    f.name.toLowerCase() === 'status' && 
                    f.dataType === 'SINGLE_SELECT'
                  );
                  
                  // Finn Ferdigdato-feltet
                  const ferdigdatoField = fields.find(f => 
                    (f.name.toLowerCase().includes('ferdigdato') || 
                     f.name.toLowerCase().includes('ferdig dato') ||
                     f.name.toLowerCase() === 'completion date' ||
                     f.name.toLowerCase() === 'slutt' ||
                     f.name.toLowerCase() === 'sluttdato') && 
                    f.dataType === 'DATE'
                  );
                  
                  // Oppdater Status hvis feltet finnes
                  if (statusField && statusField.options) {
                    const levertOption = statusField.options.find(opt => 
                      opt.name.toLowerCase().includes('levert') ||
                      opt.name.toLowerCase().includes('ferdig') ||
                      opt.name.toLowerCase().includes('done') ||
                      opt.name.toLowerCase().includes('complete')
                    );
                    
                    if (levertOption) {
                      const statusMutation = `
                        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                          updateProjectV2ItemFieldValue(input: {
                            projectId: $projectId,
                            itemId: $itemId,
                            fieldId: $fieldId,
                            value: { singleSelectOptionId: $optionId }
                          }) {
                            projectV2Item {
                              id
                            }
                          }
                        }
                      `;
                      
                      await github.graphql(statusMutation, {
                        projectId: project.id,
                        itemId: projectItem.id,
                        fieldId: statusField.id,
                        optionId: levertOption.id
                      });
                      
                      console.log(`Oppdatert status til "${levertOption.name}" i prosjekt "${project.title}"`);
                    }
                  }
                  
                  // Oppdater Ferdigdato hvis feltet finnes
                  if (ferdigdatoField) {
                    console.log(`Fant ferdigdato-felt: "${ferdigdatoField.name}" i prosjekt "${project.title}"`);
                    
                    const dateMutation = `
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $date: Date!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId,
                          itemId: $itemId,
                          fieldId: $fieldId,
                          value: { date: $date }
                        }) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `;
                    
                    try {
                      await github.graphql(dateMutation, {
                        projectId: project.id,
                        itemId: projectItem.id,
                        fieldId: ferdigdatoField.id,
                        date: today
                      });
                      
                      console.log(`Satt ferdigdato til ${today} i prosjekt "${project.title}"`);
                    } catch (dateError) {
                      console.error(`Feil ved setting av ferdigdato i "${project.title}":`, dateError.message);
                    }
                  } else {
                    console.log(`Ingen ferdigdato-felt funnet i prosjekt "${project.title}"`);
                  }
                }
              }
              
              console.log(`Issue #${issueNumber} prosessert for Levert-status`);
              
            } catch (error) {
              console.error('Feil ved flytting til Levert-kolonne:', error);
              console.error('Detaljer:', error.message);
            }

      - name: Legg til ferdigstillingskommentar
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Sak ferdigstilt**

Denne saken har automatisk blitt oppdatert:
- üìÖ Ferdigdato satt til: ${today}
- üè∑Ô∏è Status oppdatert til: Levert
- üìä Flyttet til Levert-kolonne i begge saksoversikter

_Automatisk generert av GitHub Actions workflow_`
            });
            
            console.log(`Ferdigstillingskommentar lagt til p√• issue #${issueNumber}`);