name: Automatisk Ferdigdato og Status

on:
  issues:
    types: [closed]

jobs:
  update-completion-date:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sjekk om issue skal f√• ferdigdato
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Issue #${issueNumber} lukket`);
            console.log(`State reason: ${issue.state_reason}`);
            
            // Sjekk om issue er lukket som "not planned" - da skal vi IKKE sette ferdigdato
            if (issue.state_reason === 'not_planned') {
              console.log('Issue lukket som "not planned" - avbryter ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // Sjekk om issue har label som indikerer at den ikke skal ha ferdigdato
            const labels = issue.labels.map(label => label.name.toLowerCase());
            const skipLabels = ['wontfix', 'invalid', 'duplicate', 'ikke-planlagt', 'avvist'];
            const shouldSkip = labels.some(label => skipLabels.includes(label));
            
            if (shouldSkip) {
              console.log('Issue har label som indikerer at den ikke skal ha ferdigdato');
              core.setOutput('should_continue', 'false');
              return;
            }
            
            // For alle andre tilfeller (completed eller null), sett ferdigdato
            console.log('Issue skal f√• ferdigdato');
            core.setOutput('should_continue', 'true');

      - name: Sett ferdigdato og oppdater status til Levert
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Setter ferdigdato for issue #${issueNumber}`);
            
            // Sjekk om ferdigdato allerede er satt
            const body = issue.body || '';
            const completionDatePattern = /Ferdig\s*dato:\s*(\d{4}-\d{2}-\d{2})/i;
            const existingCompletionDate = body.match(completionDatePattern);
            
            if (!existingCompletionDate) {
              // Legg til ferdigdato i issue body
              let newBody = body;
              
              // Hvis body er tom, opprett grunnleggende struktur
              if (!body.trim()) {
                newBody = `## Beskrivelse\n\n## Ferdigdato\n${today}\n\n## Akseptansekriterier\n- [x] Ferdigstilt`;
              } else {
                // Legg til ferdigdato etter startdato eller p√• slutten
                if (newBody.includes('## Startdato') || newBody.includes('## Start dato')) {
                  // Finn startdato seksjon og legg til ferdigdato etter den
                  const lines = newBody.split('\n');
                  let insertIndex = -1;
                  
                  for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes('startdato') || lines[i].toLowerCase().includes('start dato')) {
                      insertIndex = i + 1;
                      // Finn slutten av startdato seksjonen
                      while (insertIndex < lines.length && 
                             !lines[insertIndex].startsWith('## ') && 
                             !lines[insertIndex].startsWith('# ') &&
                             lines[insertIndex].trim() !== '') {
                        insertIndex++;
                      }
                      break;
                    }
                  }
                  
                  if (insertIndex > -1) {
                    lines.splice(insertIndex, 0, '', '## Ferdigdato', today, '');
                  } else {
                    lines.push('', '## Ferdigdato', today, '');
                  }
                  newBody = lines.join('\n');
                } else if (newBody.includes('## ') || newBody.includes('# ')) {
                  // Legg til ferdigdato p√• slutten av strukturert innhold
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                } else {
                  // Legg til p√• slutten
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                }
              }
              
              // Oppdater issue med ny body
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: newBody
              });
              
              console.log(`Ferdigdato ${today} lagt til i issue #${issueNumber}`);
            } else {
              console.log('Ferdigdato allerede satt til:', existingCompletionDate[1]);
            }
            
            // Legg til "levert" label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['levert']
              });
              console.log(`'levert' label lagt til p√• issue #${issueNumber}`);
            } catch (error) {
              console.log('Kunne ikke legge til levert label:', error.message);
            }

      - name: Oppdater prosjekt-felter via GraphQL
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            console.log(`Oppdaterer prosjekt-felter for issue #${issueNumber}`);
            
            try {
              // Hent alle prosjekter knyttet til denne issuen
              const query = `
                query($owner: String!, $repo: String!, $issue: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issue) {
                      projectsV2(first: 10) {
                        nodes {
                          id
                          title
                          items(first: 10) {
                            nodes {
                              id
                            }
                          }
                        }
                      }
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                            title
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue: issueNumber
              };
              
              console.log('Kj√∏rer GraphQL query for √• finne prosjekter...');
              const result = await github.graphql(query, variables);
              
              console.log('GraphQL resultat:', JSON.stringify(result, null, 2));
              
              // Samle alle prosjekt-items
              const projectItems = [];
              
              // Fra projectItems (gammel struktur)
              if (result.repository.issue.projectItems && result.repository.issue.projectItems.nodes) {
                for (const item of result.repository.issue.projectItems.nodes) {
                  projectItems.push({
                    itemId: item.id,
                    projectId: item.project.id,
                    projectTitle: item.project.title
                  });
                }
              }
              
              // Fra projectsV2 (ny struktur)
              if (result.repository.issue.projectsV2 && result.repository.issue.projectsV2.nodes) {
                for (const project of result.repository.issue.projectsV2.nodes) {
                  if (project.items && project.items.nodes && project.items.nodes.length > 0) {
                    projectItems.push({
                      itemId: project.items.nodes[0].id,
                      projectId: project.id,
                      projectTitle: project.title
                    });
                  }
                }
              }
              
              console.log(`Fant ${projectItems.length} prosjekt(er) knyttet til issuen`);
              
              // For hvert prosjekt, hent felter og oppdater
              for (const projectItem of projectItems) {
                console.log(`\nBehandler prosjekt: ${projectItem.projectTitle}`);
                
                // Hent prosjektets felter
                const fieldsQuery = `
                  query($projectId: ID!) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        fields(first: 50) {
                          nodes {
                            ... on ProjectV2Field {
                              id
                              name
                              dataType
                            }
                            ... on ProjectV2SingleSelectField {
                              id
                              name
                              dataType
                              options {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const fieldsResult = await github.graphql(fieldsQuery, {
                  projectId: projectItem.projectId
                });
                
                if (!fieldsResult.node || !fieldsResult.node.fields) {
                  console.log(`Kunne ikke hente felter for prosjekt ${projectItem.projectTitle}`);
                  continue;
                }
                
                const fields = fieldsResult.node.fields.nodes;
                console.log(`Felter i prosjektet: ${fields.map(f => `${f.name} (${f.dataType})`).join(', ')}`);
                
                // Finn og oppdater Status-felt
                const statusField = fields.find(f => 
                  f.name.toLowerCase() === 'status' && 
                  f.dataType === 'SINGLE_SELECT'
                );
                
                if (statusField && statusField.options) {
                  const levertOption = statusField.options.find(opt => 
                    opt.name.toLowerCase().includes('levert') ||
                    opt.name.toLowerCase().includes('ferdig') ||
                    opt.name.toLowerCase().includes('done') ||
                    opt.name.toLowerCase().includes('complete')
                  );
                  
                  if (levertOption) {
                    try {
                      const statusMutation = `
                        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                          updateProjectV2ItemFieldValue(input: {
                            projectId: $projectId,
                            itemId: $itemId,
                            fieldId: $fieldId,
                            value: $value
                          }) {
                            projectV2Item {
                              id
                            }
                          }
                        }
                      `;
                      
                      await github.graphql(statusMutation, {
                        projectId: projectItem.projectId,
                        itemId: projectItem.itemId,
                        fieldId: statusField.id,
                        value: { 
                          singleSelectOptionId: levertOption.id
                        }
                      });
                      
                      console.log(`‚úì Oppdatert status til "${levertOption.name}"`);
                    } catch (error) {
                      console.error(`Feil ved oppdatering av status: ${error.message}`);
                    }
                  } else {
                    console.log(`Fant ingen "Levert" option i Status-feltet`);
                  }
                } else {
                  console.log(`Fant ingen Status-felt i prosjektet`);
                }
                
                // Finn og oppdater Ferdigdato-felt
                const ferdigdatoField = fields.find(f => 
                  (f.name.toLowerCase().includes('ferdigdato') || 
                   f.name.toLowerCase().includes('ferdig dato') ||
                   f.name.toLowerCase() === 'completion date' ||
                   f.name.toLowerCase() === 'end date' ||
                   f.name.toLowerCase() === 'sluttdato' ||
                   f.name.toLowerCase() === 'slutt dato' ||
                   f.name === 'Ferdigdato') && 
                  f.dataType === 'DATE'
                );
                
                if (ferdigdatoField) {
                  try {
                    console.log(`Fant ferdigdato-felt: "${ferdigdatoField.name}" (ID: ${ferdigdatoField.id})`);
                    
                    const dateMutation = `
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId,
                          itemId: $itemId,
                          fieldId: $fieldId,
                          value: $value
                        }) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `;
                    
                    await github.graphql(dateMutation, {
                      projectId: projectItem.projectId,
                      itemId: projectItem.itemId,
                      fieldId: ferdigdatoField.id,
                      value: {
                        date: today
                      }
                    });
                    
                    console.log(`‚úì Satt ferdigdato til ${today}`);
                  } catch (error) {
                    console.error(`Feil ved setting av ferdigdato: ${error.message}`);
                  }
                } else {
                  console.log(`Ingen ferdigdato-felt funnet. Tilgjengelige dato-felter: ${fields.filter(f => f.dataType === 'DATE').map(f => f.name).join(', ')}`);
                }
              }
              
            } catch (error) {
              console.error('Feil ved oppdatering av prosjekt-felter:', error);
              console.error('Detaljert feilmelding:', error.message);
              if (error.errors) {
                console.error('GraphQL errors:', JSON.stringify(error.errors, null, 2));
              }
            }

      - name: Legg til ferdigstillingskommentar
        if: steps.check.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Sak ferdigstilt**

Denne saken har automatisk blitt oppdatert:
- üìÖ Ferdigdato satt til: ${today}
- üè∑Ô∏è Status oppdatert til: Levert
- üìä Prosjekt-felter oppdatert

_Automatisk generert av GitHub Actions workflow_`
            });
            
            console.log(`Ferdigstillingskommentar lagt til p√• issue #${issueNumber}`);