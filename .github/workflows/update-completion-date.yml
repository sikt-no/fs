name: Automatisk Ferdigdato og Status

on:
  issues:
    types: [closed]

jobs:
  update-completion-date:
    runs-on: ubuntu-latest
    if: github.event.issue.state_reason == 'completed'
    
    steps:
      - name: Sett ferdigdato og oppdater status til Levert
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Issue #${issueNumber} lukket med reason: ${context.payload.issue.state_reason}`);
            
            // Sjekk at issue faktisk er lukket som completed
            if (context.payload.issue.state_reason !== 'completed') {
              console.log('Issue ikke lukket som completed - avbryter');
              return;
            }
            
            // Sjekk om ferdigdato allerede er satt
            const body = issue.body || '';
            const completionDatePattern = /Ferdig\s*dato:\s*(\d{4}-\d{2}-\d{2})/i;
            const existingCompletionDate = body.match(completionDatePattern);
            
            if (!existingCompletionDate) {
              // Legg til ferdigdato i issue body
              let newBody = body;
              
              // Hvis body er tom, opprett grunnleggende struktur
              if (!body.trim()) {
                newBody = `## Beskrivelse\n\n## Ferdigdato\n${today}\n\n## Akseptansekriterier\n- [x] Ferdigstilt`;
              } else {
                // Legg til ferdigdato etter startdato eller p√• slutten
                if (newBody.includes('## Startdato') || newBody.includes('## Start dato')) {
                  // Finn startdato seksjon og legg til ferdigdato etter den
                  const lines = newBody.split('\n');
                  let insertIndex = -1;
                  
                  for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes('startdato') || lines[i].toLowerCase().includes('start dato')) {
                      insertIndex = i + 1;
                      // Finn slutten av startdato seksjonen
                      while (insertIndex < lines.length && 
                             !lines[insertIndex].startsWith('## ') && 
                             !lines[insertIndex].startsWith('# ') &&
                             lines[insertIndex].trim() !== '') {
                        insertIndex++;
                      }
                      break;
                    }
                  }
                  
                  if (insertIndex > -1) {
                    lines.splice(insertIndex, 0, '', '## Ferdigdato', today, '');
                  } else {
                    lines.push('', '## Ferdigdato', today, '');
                  }
                  newBody = lines.join('\n');
                } else if (newBody.includes('## ') || newBody.includes('# ')) {
                  // Legg til ferdigdato p√• slutten av strukturert innhold
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                } else {
                  // Legg til p√• slutten
                  newBody = `${newBody}\n\n## Ferdigdato\n${today}`;
                }
              }
              
              // Oppdater issue med ny body
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: newBody
              });
              
              console.log(`Ferdigdato ${today} lagt til i issue #${issueNumber}`);
            } else {
              console.log('Ferdigdato allerede satt til:', existingCompletionDate[1]);
            }
            
            // Legg til "levert" label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['levert']
              });
              console.log(`'levert' label lagt til p√• issue #${issueNumber}`);
            } catch (error) {
              console.log('Kunne ikke legge til levert label:', error.message);
            }

      - name: Flytt til Levert-kolonne i begge prosjekter
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issue = context.payload.issue;
            
            console.log(`Flytter issue #${issueNumber} til Levert-kolonne i prosjekter`);
            
            // Finn begge prosjekter
            try {
              const { data: projects } = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              const offentligProject = projects.find(p => 
                p.name.toLowerCase().includes('offentlig') && 
                p.name.toLowerCase().includes('saksoversikt')
              );
              
              const internProject = projects.find(p => 
                p.name.toLowerCase().includes('saksoversikt') && 
                p.name.toLowerCase().includes('intern')
              );
              
              // Funksjon for √• flytte kort til Levert-kolonne
              const moveCardToLevert = async (project, projectName) => {
                if (!project) {
                  console.log(`${projectName} prosjekt ikke funnet`);
                  return;
                }
                
                // Hent kolonner
                const { data: columns } = await github.rest.projects.listColumns({
                  project_id: project.id
                });
                
                // Finn Levert-kolonne
                const levertColumn = columns.find(col => 
                  col.name.toLowerCase().includes('levert') ||
                  col.name.toLowerCase().includes('ferdig') ||
                  col.name.toLowerCase().includes('done') ||
                  col.name.toLowerCase().includes('complete')
                );
                
                if (!levertColumn) {
                  console.log(`Kunne ikke finne Levert-kolonne i ${projectName}`);
                  console.log(`Tilgjengelige kolonner: ${columns.map(c => c.name).join(', ')}`);
                  return;
                }
                
                // Finn eksisterende kort for denne issue i alle kolonner
                let existingCard = null;
                for (const column of columns) {
                  const { data: columnCards } = await github.rest.projects.listCards({
                    column_id: column.id,
                    archived_state: 'all'
                  });
                  
                  existingCard = columnCards.find(card => 
                    card.content_url && card.content_url.includes(`/issues/${issueNumber}`)
                  );
                  
                  if (existingCard) {
                    console.log(`Fant kort i kolonne "${column.name}" i ${projectName}`);
                    break;
                  }
                }
                
                if (existingCard) {
                  // Flytt eksisterende kort til Levert-kolonne
                  await github.rest.projects.moveCard({
                    card_id: existingCard.id,
                    position: "top",
                    column_id: levertColumn.id
                  });
                  console.log(`Flyttet kort til "${levertColumn.name}" i ${projectName}`);
                } else {
                  // Opprett nytt kort i Levert-kolonne hvis det ikke finnes
                  await github.rest.projects.createCard({
                    column_id: levertColumn.id,
                    content_id: issue.id,
                    content_type: 'Issue'
                  });
                  console.log(`Opprettet nytt kort i "${levertColumn.name}" i ${projectName}`);
                }
              };
              
              // Flytt kort i begge prosjekter
              await moveCardToLevert(offentligProject, "FS Offentlig saksoversikt");
              await moveCardToLevert(internProject, "FS Saksoversikt (intern)");
              
              console.log(`Issue #${issueNumber} flyttet til Levert-status i begge prosjekter`);
              
            } catch (error) {
              console.error('Feil ved flytting til Levert-kolonne:', error);
            }

      - name: Legg til ferdigstillingskommentar
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Sak ferdigstilt**

Denne saken har automatisk blitt oppdatert:
- üìÖ Ferdigdato satt til: ${today}
- üè∑Ô∏è Status oppdatert til: Levert
- üìä Flyttet til Levert-kolonne i begge saksoversikter

_Automatisk generert av GitHub Actions workflow_`
            });
            
            console.log(`Ferdigstillingskommentar lagt til p√• issue #${issueNumber}`);