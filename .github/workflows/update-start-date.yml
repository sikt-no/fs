name: Automatisk Startdato ved Behovsanalyse

on:
  project_card:
    types: [moved]
  issues:
    types: [opened, edited, reopened]

jobs:
  update-start-date:
    runs-on: ubuntu-latest
    if: github.event.action == 'moved'
    
    steps:
      - name: Sjekk om issue er flyttet til "Behovsanalyse"
        uses: actions/github-script@v6
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            
            // Hent issue nummer
            let issueNumber;
            if (context.eventName === 'project_card') {
              if (!context.payload.project_card.content_url) return;
              const match = context.payload.project_card.content_url.match(/issues\/(\d+)$/);
              if (!match) return;
              issueNumber = parseInt(match[1]);
            } else {
              issueNumber = context.payload.issue.number;
            }
            
            // Hent issue detaljer
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Sjekk om kortet er flyttet til "Behovsanalyse"
            let isMovedToBehovsanalyse = false;
            
            if (context.eventName === 'project_card') {
              const { data: currentColumn } = await github.rest.projects.getColumn({
                column_id: context.payload.project_card.column_id
              });
              
              // Sjekk om m책let er behovsanalyse-kolonne
              isMovedToBehovsanalyse = currentColumn.name.toLowerCase().includes('behovsanalyse') || 
                                       currentColumn.name.toLowerCase().includes('behov') ||
                                       currentColumn.name.toLowerCase().includes('analyse');
              
              console.log(`Flyttet til: "${currentColumn.name}"`);
            } else {
              // Vi bruker ikke label-baserte triggere for startdato
              isMovedToBehovsanalyse = false;
            }
            
            if (!isMovedToBehovsanalyse) {
              console.log('Issue er ikke flyttet til behovsanalyse-kolonne');
              return;
            }
            
            
            // Sjekk om startdato allerede er satt
            const body = issue.body || '';
            const startDatePattern = /Startdato:\s*(\d{4}-\d{2}-\d{2})/i;
            const existingStartDate = body.match(startDatePattern);
            
            if (existingStartDate) {
              console.log('Startdato er allerede satt til:', existingStartDate[1]);
              return;
            }
            
            // Legg til startdato i issue body
            let newBody = body;
            
            // Hvis body er tom, opprett grunnleggende struktur
            if (!body.trim()) {
              newBody = `## Beskrivelse\n\n## Startdato\n${today}\n\n## Akseptansekriterier\n- [ ] `;
            } else {
              // Legg til startdato etter beskrivelse eller p책 toppen
              if (newBody.includes('## ') || newBody.includes('# ')) {
                // Finn sted 책 sette inn startdato
                const lines = newBody.split('\n');
                let insertIndex = 0;
                
                for (let i = 0; i < lines.length; i++) {
                  if (lines[i].startsWith('## ') && !lines[i].toLowerCase().includes('startdato')) {
                    insertIndex = i + 1;
                    // Finn slutten av denne seksjonen
                    while (insertIndex < lines.length && !lines[insertIndex].startsWith('## ') && !lines[insertIndex].startsWith('# ')) {
                      insertIndex++;
                    }
                    break;
                  }
                }
                
                lines.splice(insertIndex, 0, '', '## Startdato', today, '');
                newBody = lines.join('\n');
              } else {
                // Legg til p책 toppen
                newBody = `## Startdato\n${today}\n\n${newBody}`;
              }
            }
            
            // Oppdater issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: newBody
            });
            
            console.log(`Startdato ${today} lagt til i issue #${issueNumber}`);

      - name: Legg til behovsanalyse label hvis ikke finnes
        uses: actions/github-script@v6
        with:
          script: |
            let issueNumber;
            if (context.eventName === 'project_card') {
              if (!context.payload.project_card.content_url) return;
              const match = context.payload.project_card.content_url.match(/issues\/(\d+)$/);
              if (!match) return;
              issueNumber = parseInt(match[1]);
            } else {
              issueNumber = context.payload.issue.number;
            }
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const hasBehovsanalyseLabel = issue.labels.some(label => 
              label.name.toLowerCase().includes('behovsanalyse') || 
              label.name.toLowerCase().includes('analyse')
            );
            
            if (!hasBehovsanalyseLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['behovsanalyse']
              });
            }

      - name: Oppdater Startdato i prosjekt-feltene
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let issueNumber;
            if (context.eventName === 'project_card') {
              if (!context.payload.project_card.content_url) return;
              const match = context.payload.project_card.content_url.match(/issues\/(\d+)$/);
              if (!match) return;
              issueNumber = parseInt(match[1]);
            } else {
              issueNumber = context.payload.issue.number;
            }
            
            const today = new Date().toISOString().split('T')[0];
            console.log(`Setter startdato ${today} i prosjekt-felt for issue #${issueNumber}`);
            
            try {
              // Hent issue's prosjekt-informasjon via GraphQL
              const query = `
                query($owner: String!, $repo: String!, $issue: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issue) {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                            title
                            fields(first: 20) {
                              nodes {
                                ... on ProjectV2Field {
                                  id
                                  name
                                  dataType
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue: issueNumber
              };
              
              const result = await github.graphql(query, variables);
              
              if (result.repository.issue.projectItems.nodes.length > 0) {
                console.log('Fant issue i Projects');
                
                for (const projectItem of result.repository.issue.projectItems.nodes) {
                  const project = projectItem.project;
                  const fields = project.fields.nodes;
                  
                  console.log(`Behandler prosjekt: ${project.title}`);
                  
                  // Finn Startdato-feltet
                  const startdatoField = fields.find(f => 
                    (f.name.toLowerCase().includes('startdato') || 
                     f.name.toLowerCase().includes('start dato') ||
                     f.name.toLowerCase() === 'start date' ||
                     f.name.toLowerCase() === 'start') && 
                    f.dataType === 'DATE'
                  );
                  
                  if (startdatoField) {
                    console.log(`Fant startdato-felt: "${startdatoField.name}" i prosjekt "${project.title}"`);
                    
                    const dateMutation = `
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $date: Date!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId,
                          itemId: $itemId,
                          fieldId: $fieldId,
                          value: { date: $date }
                        }) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `;
                    
                    try {
                      await github.graphql(dateMutation, {
                        projectId: project.id,
                        itemId: projectItem.id,
                        fieldId: startdatoField.id,
                        date: today
                      });
                      
                      console.log(`Satt startdato til ${today} i prosjekt "${project.title}"`);
                    } catch (dateError) {
                      console.error(`Feil ved setting av startdato i "${project.title}":`, dateError.message);
                    }
                  } else {
                    console.log(`Ingen startdato-felt funnet i prosjekt "${project.title}"`);
                    console.log(`Tilgjengelige datofelter: ${fields.filter(f => f.dataType === 'DATE').map(f => f.name).join(', ')}`);
                  }
                }
              }
            } catch (error) {
              console.error('Feil ved oppdatering av startdato i prosjekt-felt:', error);
              console.error('Detaljer:', error.message);
            }